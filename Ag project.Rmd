---
title: "Supply Estimation"
author: "Tristan Hanon & Shanchao Wang"
date: "10/16/2018"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,message = F,warning = F)
library(readstata13)
library(plyr)
library(tidyverse)
library(stargazer)
library(broom)
library(ggplot2)
library(rms)
library(sandwich)
library(lmtest)
library(AER)
```

```{r reading data}
CPI    = read.table("Data/CPI.csv",sep = ",",header = T)
area   = read.table("Data/FAOSTAT_data_2017.csv",sep = ",",header = T)
stock  = read.table("Data/FAOSTAT_stocks_data_2017.csv",sep = ",",header = T)
hemisphere = read.dta13("Data/hemisphere.dta")
quantities = read.dta13("Data/global_quantities.dta")
prices     = read.dta13("Data/global_prices.dta")
calorie    = read.dta13("Data/caloric_panel.dta")
```

```{r replicate STATA code,warning=F}
workdata = merge(quantities,prices,by.x = "year",by.y = "year",all = T)

#calorie weights 
kappa_maize=2204.622*(862/1316)*1690/(2000*365.25)
kappa_rice=2204.622*(1288/2178)*1590/(2000*365.25) 
kappa_soybeans=2204.622*(908/966)*1590/(2000*365.25)
kappa_wheat=2204.622*(489/798)*1615/(2000*365.25)

#generate future prices
workdata = workdata %>% mutate(fut_price = (kappa_maize*C_fut_price +kappa_soybeans*S_fut_price + kappa_wheat*W_fut_price)/(kappa_maize+kappa_soybeans+kappa_wheat)
)

#generate variables to be used in regressions
workdata = workdata %>% mutate(ln_q = log(prod), ln_p = log(lag(fut_price)/lag(cpi)), ln_w = log(yield_shock))

#regressions
aaron1 = lm(ln_q ~ ln_p + rcs(year,4),data = workdata)
aaronres1 = coeftest(aaron1,vcov. = NeweyWest(aaron1))

aaron2 = lm(ln_q ~ ln_p + ln_w + rcs(year,4),data = workdata)
aaronres2 = coeftest(aaron2,vcov. = NeweyWest(aaron2))

aaron3 = ivreg(ln_q ~ ln_p + ln_w + rcs(year,4)|lag(ln_w,1) + ln_w + rcs(year,4),data = workdata)
aaronres3 = coeftest(aaron3,vcov. = NeweyWest(aaron3))
```

```{r disaggregation with crops, results='asis'}
# Aaron included rice production in ln_q, but since the future market for rice starts at 1986, rice future price is not calculated into ln_p
# Generate calorie prod for disaggregated crops
workdata = workdata %>% mutate(maize_prod_c = maize_prod*kappa_maize/1000000,
                               rice_prod_c = rice_prod*kappa_rice/1000000,
                               soybeans_prod_c = soybeans_prod*kappa_soybeans/1000000,
                               wheat_prod_c = wheat_prod*kappa_wheat/1000000)

###################################
###################################
# Model 1 ln_q = ln_p + rcs(year,4)
workdata = workdata %>% mutate(ln_p = log(lag(C_fut_price)/lag(cpi)))
maize1 = lm(log(maize_prod_c) ~ ln_p  + rcs(year,4),data = workdata)
maizeres1 = coeftest(maize1,vcov. = NeweyWest(maize1))

workdata = workdata %>% mutate(ln_p = log(lag(RR_fut_price)/lag(cpi)))
rice1 = lm(log(rice_prod_c) ~ ln_p  + rcs(year,4),data = workdata)
# riceres1 = coeftest(rice1,vcov. = NeweyWest(rice1)) #Newey is not working here
riceres1 = coeftest(rice1)

workdata = workdata %>% mutate(ln_p = log(lag(S_fut_price)/lag(cpi)))
soybeans1 = lm(log(soybeans_prod_c) ~ ln_p  + rcs(year,4),data = workdata)
soybeansres1 = coeftest(soybeans1,vcov. = NeweyWest(soybeans1))

workdata = workdata %>% mutate(ln_p = log(lag(W_fut_price)/lag(cpi)))
wheat1 = lm(log(wheat_prod_c) ~ ln_p  + rcs(year,4),data = workdata)
wheatres1 = coeftest(wheat1,vcov. = NeweyWest(wheat1))

stargazer(aaronres1,maizeres1,riceres1,soybeansres1,wheatres1,header = F,column.labels = c("aggregate","maize","rice","soybeans","wheat"))

###################################
###################################
# Model 2 ln_q = ln_p + ln_w +rcs(year,4)
# ln_w = log(yield shock), yield_shock = prod(in calorie)/yield_trend

workdata = workdata %>% mutate(ln_p = log(lag(C_fut_price)/lag(cpi)), ln_w = log(maize_prod_c/yield_trend_C))
maize2 = lm(log(maize_prod_c) ~ ln_p  + ln_w + rcs(year,4),data = workdata)
maizeres2 = coeftest(maize2,vcov. = NeweyWest(maize2))

workdata = workdata %>% mutate(ln_p = log(lag(RR_fut_price)/lag(cpi)), ln_w = log(rice_prod_c/yield_trend_RR))
rice2 = lm(log(rice_prod_c) ~ ln_p  + ln_w + rcs(year,4),data = workdata)
#riceres2 = coeftest(rice2,vcov. = NeweyWest(rice2)) #Newey is not working here
riceres2 = coeftest(rice2)

workdata = workdata %>% mutate(ln_p = log(lag(S_fut_price)/lag(cpi)),ln_w = log(soybeans_prod_c/yield_trend_S))
soybeans2 = lm(log(soybeans_prod_c) ~ ln_p + ln_w + rcs(year,4),data = workdata)
soybeansres2 = coeftest(soybeans2,vcov. = NeweyWest(soybeans2))

workdata = workdata %>% mutate(ln_p = log(lag(W_fut_price)/lag(cpi)),ln_w = log(wheat_prod_c/yield_trend_W))
wheat2 = lm(log(wheat_prod_c) ~ ln_p + ln_w + rcs(year,4),data = workdata)
wheatres2 = coeftest(wheat2,vcov. = NeweyWest(wheat2))

stargazer(aaronres2,maizeres2,riceres2,soybeansres2,wheatres2,header = F,column.labels = c("aggregate","maize","rice","soybeans","wheat"))

###################################
###################################
# Model 3 ln_q = ln_p + ln_w +rcs(year,4)
# ln_w = log(yield shock), yield_shock = prod(in calorie)/yield_trend

workdata = workdata %>% mutate(ln_p = log(lag(C_fut_price)/lag(cpi)), ln_w = log(maize_prod_c/yield_trend_C))
maize3 = ivreg(log(maize_prod_c) ~ ln_p + ln_w + rcs(year,4)|lag(ln_w,1) + ln_w + rcs(year,4),data = workdata)
maizeres3 = coeftest(maize3,vcov. = NeweyWest(maize3))

workdata = workdata %>% mutate(ln_p = log(lag(RR_fut_price)/lag(cpi)), ln_w = log(rice_prod_c/yield_trend_RR))
rice3 = ivreg(log(rice_prod_c) ~ ln_p + ln_w + rcs(year,4)|lag(ln_w,1) + ln_w + rcs(year,4),data = workdata)
#riceres3 = coeftest(rice3,vcov. = NeweyWest(rice3))
riceres3 = coeftest(rice3)

workdata = workdata %>% mutate(ln_p = log(lag(S_fut_price)/lag(cpi)),ln_w = log(soybeans_prod_c/yield_trend_S))
soybeans3 = ivreg(log(soybeans_prod_c) ~ ln_p + ln_w + rcs(year,4)|lag(ln_w,1) + ln_w + rcs(year,4),data = workdata)
soybeansres3 = coeftest(soybeans3,vcov. = NeweyWest(soybeans3))

workdata = workdata %>% mutate(ln_p = log(lag(W_fut_price)/lag(cpi)),ln_w = log(wheat_prod_c/yield_trend_W))
wheat3 =  ivreg(log(wheat_prod_c) ~ ln_p + ln_w + rcs(year,4)|lag(ln_w,1) + ln_w + rcs(year,4),data = workdata)
wheatres3 = coeftest(wheat3,vcov. = NeweyWest(wheat3))

stargazer(aaronres3,maizeres3,riceres3,soybeansres3,wheatres3,header = F,column.labels = c("aggregate","maize","rice","soybeans","wheat"))
```





