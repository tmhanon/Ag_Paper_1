---
title: "Supply Estimation"
author: "Tristan Hanon & Shanchao Wang"
date: "10/16/2018"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,message = F,warning = F)
library(readstata13)
library(tidyverse)
library(stargazer)
library(broom)
library(ggplot2)
library(sandwich)
library(rms)
library(lmtest)
library(AER)
```

```{r reading data}
CPI    = read.table("Data/CPI.csv",sep = ",",header = T)
area   = read.table("Data/FAOSTAT_data_2017.csv",sep = ",",header = T)
stock  = read.table("Data/FAOSTAT_stocks_data_2017.csv",sep = ",",header = T)
hemisphere = read.dta13("Data/hemisphere.dta")
quantities = read.dta13("Data/global_quantities.dta")
prices     = read.dta13("Data/global_prices.dta")
calorie    = read.dta13("Data/caloric_panel.dta")
```

```{r replicate STATA code,results='asis',warning=F}
workdata = merge(quantities,prices,by.x = "year",by.y = "year",all = T)

#calorie weights 
kappa_maize=2204.622*(862/1316)*1690/(2000*365.25)
kappa_rice=2204.622*(1288/2178)*1590/(2000*365.25) 
kappa_soybeans=2204.622*(908/966)*1590/(2000*365.25)
kappa_wheat=2204.622*(489/798)*1615/(2000*365.25)

#generate future prices
workdata = workdata %>% mutate(fut_price = (kappa_maize*C_fut_price +kappa_soybeans*S_fut_price + kappa_wheat*W_fut_price)/(kappa_maize+kappa_soybeans+kappa_wheat)
)

#generate variables to be used in regressions
workdata = workdata %>% mutate(ln_q = log(prod), ln_p = log(lag(fut_price)/lag(cpi)), ln_w = log(yield_shock))

#regressions
reg1 = lm(ln_q ~ ln_p + rcs(year,4),data = workdata)
res1 = coeftest(reg1,vcov. = NeweyWest(reg1))

reg2 = lm(ln_q ~ ln_p + ln_w + rcs(year,4),data = workdata)
res2 = coeftest(reg2,vcov. = NeweyWest(reg2))

reg3 = ivreg(ln_q ~ ln_p + ln_w + rcs(year,4)|lag(ln_w,1) + ln_w + rcs(year,4),data = workdata)
res3 = coeftest(reg3,vcov. = NeweyWest(reg3))
stargazer(res1,res2,res3,header = F)
```







